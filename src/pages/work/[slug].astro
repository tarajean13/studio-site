---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getCollection, render } from "astro:content";

export async function getStaticPaths() {
  const projects = await getCollection("projects");
  return projects
    .filter((p) => !p.data.comingSoon)
    .map((project) => ({
      params: { slug: project.id },
      props: { project },
    }));
}

const { project } = Astro.props;
const { Content } = await render(project);

const allProjects = await getCollection("projects");
const sorted = allProjects.filter((p) => !p.data.comingSoon).sort((a, b) => a.data.order - b.data.order);
const currentIndex = sorted.findIndex((p) => p.id === project.id);
const prevProject = currentIndex > 0 ? sorted[currentIndex - 1] : null;
const nextProject = currentIndex < sorted.length - 1 ? sorted[currentIndex + 1] : null;
---

<BaseLayout title={project.data.title} description={project.data.description}>
  <!-- Hero Image -->
  <section class="w-full">
    <div class="aspect-[16/7] overflow-hidden bg-border">
      <img
        src={project.data.heroImage || project.data.thumbnail}
        alt={project.data.title}
        class="w-full h-full object-cover"
      />
    </div>
  </section>

  <!-- Project Info -->
  <section class="px-6 lg:px-12 max-w-7xl mx-auto py-16 lg:py-24">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-12 lg:gap-16">
      <div class="lg:col-span-2">
        <h1 class="text-4xl md:text-5xl font-heading font-medium mb-6">
          {project.data.title}
        </h1>
        <p class="text-lg text-secondary leading-relaxed">
          {project.data.description}
        </p>
      </div>
      <div class="flex flex-col gap-6">
        <div>
          <h3 class="text-sm uppercase tracking-wide text-muted mb-2">Year</h3>
          <p class="text-primary">{project.data.year}</p>
        </div>
        <div>
          <h3 class="text-sm uppercase tracking-wide text-muted mb-2">Disciplines</h3>
          <div class="flex flex-wrap gap-2">
            {project.data.disciplines.map((d: string) => (
              <span class="text-sm text-primary">{d}</span>
            ))}
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Project Content -->
  <section class="px-6 lg:px-12 max-w-3xl mx-auto pb-16 lg:pb-24">
    <div class="prose prose-neutral max-w-none
      [&_h2]:font-heading [&_h2]:text-2xl [&_h2]:font-medium [&_h2]:mt-12 [&_h2]:mb-4
      [&_h3]:font-heading [&_h3]:text-lg [&_h3]:font-medium [&_h3]:mt-8 [&_h3]:mb-3
      [&_p]:text-secondary [&_p]:leading-relaxed [&_p]:mb-4
      [&_ul]:text-secondary [&_ul]:leading-relaxed [&_ul]:mb-4 [&_ul]:list-disc [&_ul]:pl-5
      [&_li]:mb-1">
      <Content />
    </div>
  </section>

  <!-- Prev/Next Navigation -->
  <section class="px-6 lg:px-12 max-w-7xl mx-auto pb-16 lg:pb-24">
    <div class="border-t border-border pt-12 grid grid-cols-2 gap-8">
      {prevProject ? (
        <a href={`/work/${prevProject.id}`} class="group">
          <span class="text-sm uppercase tracking-wide text-muted">Previous</span>
          <p class="font-heading text-lg font-medium mt-1 group-hover:text-secondary transition-colors">
            {prevProject.data.title}
          </p>
        </a>
      ) : <div />}
      {nextProject ? (
        <a href={`/work/${nextProject.id}`} class="group text-right">
          <span class="text-sm uppercase tracking-wide text-muted">Next</span>
          <p class="font-heading text-lg font-medium mt-1 group-hover:text-secondary transition-colors">
            {nextProject.data.title}
          </p>
        </a>
      ) : <div />}
    </div>
  </section>
</BaseLayout>
